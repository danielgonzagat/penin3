#!/bin/bash
# ๐ COMANDO รNICO - APLICA TUDO DA FASE 1 E RESTART BRAIN

set -e  # Para em erro

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ COMANDO รNICO - FASE 1 COMPLETA"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "Este script executa TUDO da Fase 1 automaticamente:"
echo "  1. Aplica 7 fixes"
echo "  2. Restart UNIFIED_BRAIN"
echo "  3. Inicia monitoramento"
echo ""

read -p "Pressione ENTER para executar ou Ctrl+C para cancelar..."

# Timestamp
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 1: Aplicar fixes
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "PASSO 1: Aplicando fixes automรกticos..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if [ -f /root/SCRIPT_APLICAR_FIXES_AUTOMATICO.sh ]; then
    bash /root/SCRIPT_APLICAR_FIXES_AUTOMATICO.sh || {
        echo "โ๏ธ  Alguns fixes falharam - continuando mesmo assim"
    }
else
    echo "โ๏ธ  SCRIPT_APLICAR_FIXES_AUTOMATICO.sh nรฃo encontrado"
    echo "   Pulando fixes automรกticos"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 2: Parar BRAIN antigo
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "PASSO 2: Parando UNIFIED_BRAIN antigo..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# Verificar se estรก rodando
if ps -p 1497200 > /dev/null 2>&1; then
    echo "โ Encontrado PID 1497200 - parando..."
    kill 1497200 2>/dev/null || kill -9 1497200 2>/dev/null
    sleep 2
    
    if ps -p 1497200 > /dev/null 2>&1; then
        echo "โ๏ธ  Processo ainda rodando - forรงando kill -9"
        kill -9 1497200
        sleep 1
    fi
    
    echo "โ Processo antigo parado"
else
    echo "โ Processo jรก estava parado"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 3: Criar diretรณrio de logs se nรฃo existir
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "PASSO 3: Preparando ambiente..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

mkdir -p /root/UNIFIED_BRAIN/logs
echo "โ Diretรณrios criados"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 4: Restart UNIFIED_BRAIN
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "PASSO 4: Iniciando UNIFIED_BRAIN com fixes aplicados..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

cd /root/UNIFIED_BRAIN

# Verificar se arquivo existe
if [ ! -f brain_daemon_real_env.py ]; then
    echo "โ brain_daemon_real_env.py nรฃo encontrado!"
    echo "   Verifique /root/UNIFIED_BRAIN/"
    exit 1
fi

# Iniciar novo processo
nohup python3 brain_daemon_real_env.py > brain_restart_${TIMESTAMP}.log 2>&1 &
NEW_PID=$!

# Salvar PID
echo $NEW_PID > brain_restart.pid

echo "โ UNIFIED_BRAIN iniciado"
echo "   PID: $NEW_PID"
echo "   Log: brain_restart_${TIMESTAMP}.log"

# Aguardar 5s para ver se nรฃo crashou imediatamente
sleep 5

if ps -p $NEW_PID > /dev/null 2>&1; then
    echo "โ Processo rodando estรกvel"
else
    echo "โ Processo crashou imediatamente!"
    echo "   Verificar log: tail -50 brain_restart_${TIMESTAMP}.log"
    exit 1
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASSO 5: Instruรงรตes de monitoramento
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ FASE 1 COMPLETA!"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ UNIFIED_BRAIN reiniciado com todos os fixes!"
echo ""
echo "๐ Monitorar agora (deixe rodando 30 minutos):"
echo ""
echo "   # Terminal 1: Logs em tempo real"
echo "   tail -f /root/UNIFIED_BRAIN/brain_restart_${TIMESTAMP}.log"
echo ""
echo "   # Terminal 2: Dashboard atualizado"
echo "   watch -n 5 cat /root/UNIFIED_BRAIN/dashboard.txt"
echo ""
echo "   # Terminal 3: Processos ativos"
echo "   watch -n 5 'ps aux | grep -E \"brain|darwin|penin\" | grep -v grep'"
echo ""
echo "๐ O que esperar nos prรณximos 30 minutos:"
echo ""
echo "   โ Episode count aumentando (1, 2, 3, ...)"
echo "   โ Rewards melhorando gradualmente"
echo "   โ Loss diminuindo"
echo "   โ 'Dashboard saved' a cada 5 episodes"
echo "   โ Zero crashes de AttributeError"
echo "   โ Active neurons > 5"
echo ""
echo "๐ Se tudo funcionar (rewards subindo, zero crashes):"
echo "   โ Sistema estรก aprendendo!"
echo "   โ Pronto para Fase 2 (integraรงรตes)"
echo ""
echo "๐ Se tiver problemas:"
echo "   โ Verificar: tail -100 brain_restart_${TIMESTAMP}.log"
echo "   โ Backups estรฃo em: /root/BACKUP_FASE1_*/"
echo "   โ Me avise: vou te ajudar a debugar"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ COMANDO RรPIDO PARA MONITORAR:"
echo ""
echo "tail -f /root/UNIFIED_BRAIN/brain_restart_${TIMESTAMP}.log"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# Manter terminal aberto
exec bash