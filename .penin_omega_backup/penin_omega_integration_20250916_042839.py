#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
PENIN-Œ© Integration Layer - Conecta m√≥dulos 1/8 e 2/8
====================================================
Interface de integra√ß√£o entre N√∫cleo (1/8) e Estrat√©gico (2/8)
com conex√£o HTTP ao Falcon Mamba 7B
"""

import asyncio
import aiohttp
import json
import time
from typing import Dict, Any, Optional, Union
from dataclasses import asdict

# Importar m√≥dulos
try:
    from penin_omega_2_strategy import (
        StrategyModuleFusion, 
        OmegaState, 
        create_strategy_module,
        CORE_INTEGRATION
    )
    STRATEGY_AVAILABLE = True
except ImportError:
    STRATEGY_AVAILABLE = False
    logger.info("‚ö†Ô∏è M√≥dulo 2/8 n√£o encontrado")

# =============================================================================
# HTTP LLM Provider para Falcon Mamba
# =============================================================================

class FalconMambaProvider:
    """Provider HTTP para Falcon Mamba 7B na porta 8010"""
    
    def __init__(self, base_url: str = "http://localhost:8010"):
        self.base_url = base_url
        self.session = None
        
    async def _get_session(self):
        if not self.session:
            timeout = aiohttp.ClientTimeout(total=30)
            self.session = aiohttp.ClientSession(timeout=timeout)
        return self.session
    
    async def generate(self, prompt: str, max_tokens: int = 150, temperature: float = 0.7) -> str:
        """Gera resposta via HTTP"""
        try:
            session = await self._get_session()
            
            payload = {
                "prompt": prompt,
                "max_tokens": max_tokens,
                "temperature": temperature,
                "stream": False
            }
            
            async with session.post(f"{self.base_url}/generate", json=payload) as resp:
                if resp.status == 200:
                    result = await resp.json()
                    return result.get("response", "").strip()
                else:
                    return f"HTTP Error {resp.status}"
                    
        except Exception as e:
            return f"Connection error: {str(e)}"
    
    async def close(self):
        if self.session:
            await self.session.close()

# =============================================================================
# Integra√ß√£o Principal 1/8 + 2/8
# =============================================================================

class PeninOmegaIntegration:
    """Integra√ß√£o completa entre m√≥dulos 1/8 e 2/8"""
    
    def __init__(self):
        logger.info("üîó Inicializando integra√ß√£o PENIN-Œ© 1/8 + 2/8...")
        
        # Inicializar m√≥dulo 2/8
        if STRATEGY_AVAILABLE:
            self.strategy_module = create_strategy_module()
            logger.info("‚úÖ M√≥dulo 2/8 (Estrat√©gico) carregado")
        else:
            self.strategy_module = None
            logger.info("‚ùå M√≥dulo 2/8 n√£o dispon√≠vel")
        
        # Provider LLM
        self.llm_provider = FalconMambaProvider()
        
        # Estado atual simulado (normalmente viria do 1/8)
        self.current_state = OmegaState(
            E_ok=0.95, M=0.85, C=0.80, A=0.75,
            ece=0.008, rho_bias=1.02, fairness=0.96,
            consent=True, eco_ok=True,
            rho=0.75, uncertainty=0.25, volatility=0.15,
            delta_linf=0.018, mdl_gain=0.035, ppl_ood=88.0,
            efficiency=0.75, caos_post=1.35, caos_stable=True,
            self_improvement=0.72, exploration=0.65, adaptation=0.80,
            sr_score=0.85, trust_region_radius=0.12, cycle_count=1
        )
        
        logger.info("üß† Estado inicial configurado")
        logger.info("üöÄ Integra√ß√£o pronta!")
    
    async def process_intent(self, intent: str, context: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Processa inten√ß√£o atrav√©s do pipeline 1/8 ‚Üí 2/8"""
        
        if not self.strategy_module:
            return {"error": "M√≥dulo 2/8 n√£o dispon√≠vel"}
        
        logger.info(f"\nüìù Processando inten√ß√£o: '{intent}'")
        
        # 1. Atualizar estado (simulado - normalmente viria do 1/8)
        self.current_state.cycle_count += 1
        self.current_state.timestamp = time.time()
        
        # 2. Criar plano estrat√©gico via 2/8
        logger.info("üéØ Gerando plano estrat√©gico...")
        start_time = time.time()
        
        plan_result = self.strategy_module.create_plan(
            state=self.current_state,
            intent=intent,
            context=context or {}
        )
        
        generation_time = (time.time() - start_time) * 1000
        logger.info(f"‚ö° Plano gerado em {generation_time:.2f}ms")
        
        # 3. Enriquecer com LLM se necess√°rio
        if "explain" in intent.lower() or "rationale" in intent.lower():
            logger.info("ü§ñ Enriquecendo com Falcon Mamba...")
            llm_prompt = f"Explique brevemente este plano estrat√©gico: {plan_result['PlanŒ©']['rationale']}"
            llm_response = await self.llm_provider.generate(llm_prompt, max_tokens=100)
            plan_result["llm_explanation"] = llm_response
        
        # 4. Preparar resposta integrada
        response = {
            "success": True,
            "intent": intent,
            "processing_time_ms": generation_time,
            "state_cycle": self.current_state.cycle_count,
            "plan": plan_result["PlanŒ©"],
            "sr_report": plan_result["SR_report"],
            "u_signal": plan_result["U_signal"],
            "proof": plan_result["proof"],
        }
        
        if "llm_explanation" in plan_result:
            response["llm_explanation"] = plan_result["llm_explanation"]
        
        return response
    
    async def get_system_status(self) -> Dict[str, Any]:
        """Status completo do sistema integrado"""
        
        status = {
            "timestamp": time.time(),
            "integration_active": True,
            "modules": {
                "1/8_core": "simulated",  # Seria real com 1/8
                "2/8_strategy": STRATEGY_AVAILABLE,
            },
            "llm_provider": {
                "type": "falcon_mamba_7b",
                "endpoint": self.llm_provider.base_url,
                "status": "unknown"  # Testaremos
            },
            "current_state": {
                "cycle": self.current_state.cycle_count,
                "sr_score": self.current_state.sr_score,
                "rho": self.current_state.rho,
                "trust_region": self.current_state.trust_region_radius,
            }
        }
        
        # Testar conex√£o com Falcon Mamba
        try:
            test_response = await self.llm_provider.generate("Test", max_tokens=10)
            if "error" not in test_response.lower():
                status["llm_provider"]["status"] = "connected"
            else:
                status["llm_provider"]["status"] = "error"
                status["llm_provider"]["error"] = test_response
        except Exception as e:
            status["llm_provider"]["status"] = "disconnected"
            status["llm_provider"]["error"] = str(e)
        
        # Telemetria do 2/8
        if self.strategy_module:
            status["strategy_telemetry"] = self.strategy_module.get_telemetry()
        
        return status
    
    async def simulate_evolution_cycle(self) -> Dict[str, Any]:
        """Simula um ciclo completo de evolu√ß√£o"""
        
        logger.info("\nüîÑ Simulando ciclo de evolu√ß√£o...")
        
        # 1. Inten√ß√£o autom√°tica baseada no estado
        if self.current_state.rho > 0.8:
            intent = "Reduzir risco œÅ para n√≠veis seguros mantendo performance"
        elif self.current_state.fairness < 0.97:
            intent = "Melhorar fairness sem comprometer efici√™ncia"
        elif self.current_state.ppl_ood > 90:
            intent = "Melhorar robustez OOD em 10% com foco em calibra√ß√£o"
        else:
            intent = "Otimizar performance geral mantendo √©tica e seguran√ßa"
        
        # 2. Processar inten√ß√£o
        result = await self.process_intent(intent)
        
        # 3. Simular execu√ß√£o (atualizar estado)
        if result.get("success"):
            plan = result["plan"]
            
            # Aplicar mudan√ßas simuladas baseadas nos objetivos
            for goal in plan.get("goals", []):
                metric = goal.get("metric")
                target = goal.get("target", 0)
                
                if metric == "rho":
                    self.current_state.rho = min(0.95, target * 1.1)  # Progresso parcial
                elif metric == "fairness":
                    self.current_state.fairness = min(1.0, target * 0.98)
                elif metric == "ppl_ood":
                    self.current_state.ppl_ood = max(80, target * 1.05)
                elif metric == "sr_score":
                    self.current_state.sr_score = min(1.0, target * 0.95)
            
            # Atualizar m√©tricas derivadas
            self.current_state.delta_linf = min(0.05, self.current_state.delta_linf * 1.1)
            self.current_state.uncertainty = max(0.1, self.current_state.uncertainty * 0.95)
            
            logger.info(f"‚úÖ Ciclo completo - SR: {self.current_state.sr_score:.3f}, œÅ: {self.current_state.rho:.3f}")
        
        return result
    
    async def close(self):
        """Limpa recursos"""
        await self.llm_provider.close()

# =============================================================================
# Interface CLI para Testes
# =============================================================================

async def main():
    """Fun√ß√£o principal de teste da integra√ß√£o"""
    
    logger.info("="*80)
    logger.info("üß† PENIN-Œ© Integration Test - 1/8 + 2/8 + Falcon Mamba")
    logger.info("="*80)
    
    # Inicializar integra√ß√£o
    integration = PeninOmegaIntegration()
    
    try:
        # 1. Status do sistema
        logger.info("\nüìä Status do Sistema:")
        logger.info("-"*40)
        status = await integration.get_system_status()
        
        logger.info(f"M√≥dulos ativos:")
        for module, active in status["modules"].items():
            status_icon = "‚úÖ" if active else "‚ùå"
            logger.info(f"  {status_icon} {module}: {active}")
        
        logger.info(f"\nFalcon Mamba:")
        llm_status = status["llm_provider"]["status"]
        status_icon = "‚úÖ" if llm_status == "connected" else "‚ö†Ô∏è" if llm_status == "error" else "‚ùå"
        logger.info(f"  {status_icon} Status: {llm_status}")
        if "error" in status["llm_provider"]:
            logger.info(f"  Error: {status['llm_provider']['error']}")
        
        logger.info(f"\nEstado atual:")
        state = status["current_state"]
        logger.info(f"  Ciclo: {state['cycle']}")
        logger.info(f"  SR Score: {state['sr_score']:.3f}")
        logger.info(f"  Risco œÅ: {state['rho']:.3f}")
        logger.info(f"  Trust Region: {state['trust_region']:.3f}")
        
        # 2. Teste de inten√ß√µes
        logger.info(f"\nüéØ Testando Processamento de Inten√ß√µes:")
        logger.info("-"*40)
        
        test_intents = [
            "Melhorar robustez OOD em 5% mantendo œÅ<0.9",
            "Reduzir bias algor√≠tmico com foco em fairness",
            "Otimizar efici√™ncia sem comprometer √©tica",
        ]
        
        for i, intent in enumerate(test_intents, 1):
            logger.info(f"\n{i}. Inten√ß√£o: '{intent}'")
            
            result = await integration.process_intent(intent)
            
            if result.get("success"):
                plan = result["plan"]
                sr_report = result["sr_report"]
                
                logger.info(f"   ‚úÖ Plano gerado: {plan['id']}")
                logger.info(f"   üìä SR Score: {sr_report['sr_score']:.3f} ({sr_report['decision']})")
                logger.info(f"   üéØ Objetivos: {len(plan['goals'])}")
                logger.info(f"   ‚ö° Tempo: {result['processing_time_ms']:.2f}ms")
                logger.info(f"   üì° U-Signal: {result['u_signal']:.3f}")
                
                if "llm_explanation" in result:
                    logger.info(f"   ü§ñ LLM: {result['llm_explanation'][:100]}...")
            else:
                logger.info(f"   ‚ùå Erro: {result.get('error', 'Unknown')}")
        
        # 3. Simula√ß√£o de ciclos evolutivos
        logger.info(f"\nüîÑ Simulando Ciclos Evolutivos:")
        logger.info("-"*40)
        
        for cycle in range(3):
            logger.info(f"\nCiclo {cycle + 1}:")
            result = await integration.simulate_evolution_cycle()
            
            if result.get("success"):
                logger.info(f"   Intent: {result['intent']}")
                logger.info(f"   Objetivos: {len(result['plan']['goals'])}")
                logger.info(f"   SR: {result['sr_report']['sr_score']:.3f}")
            
            await asyncio.sleep(0.5)  # Pausa entre ciclos
        
        # 4. Status final
        logger.info(f"\nüìà Status Final:")
        logger.info("-"*40)
        final_status = await integration.get_system_status()
        final_state = final_status["current_state"]
        
        logger.info(f"Ciclos executados: {final_state['cycle']}")
        logger.info(f"SR Score final: {final_state['sr_score']:.3f}")
        logger.info(f"Risco œÅ final: {final_state['rho']:.3f}")
        
        if STRATEGY_AVAILABLE:
            telemetry = final_status["strategy_telemetry"]
            logger.info(f"Planos criados: {telemetry['plans_created']}")
            logger.info(f"Gates passados: {telemetry['gates_passed']}")
            logger.info(f"Lat√™ncia m√©dia: {telemetry['avg_latency_ms']:.2f}ms")
        
    except Exception as e:
        logger.info(f"‚ùå Erro na integra√ß√£o: {e}")
        import traceback
        traceback.print_exc()
    
    finally:
        await integration.close()
    
    logger.info(f"\n{'='*80}")
    logger.info("‚úÖ Teste de Integra√ß√£o Completo!")
    logger.info(f"{'='*80}")

if __name__ == "__main__":
    asyncio.run(main())
